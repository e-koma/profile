# 業務経歴
- primeNumber: 2023-2024

## 成果サマリ

- 可用性向上
  - ゼロダウンタイムの EKS カナリアアップグレードを設計および実装
- リソース最適化
  - 特定の k8s Job のメモリ確保量を 1000 GB 以上削減
- 各種高速化
  - オートスケールの速度を 5分 高速化
  - スケジューラの開始遅延を 10分から1分 へ改善
  - ワークフロー処理の起動速度を 3分 以上高速化

## 技術的貢献 (ピックアップ)

### 1. ゼロダウンタイムの EKS カナリアアップグレードを設計および実装

#### 課題
- k8s の定期 upgrade による環境変更リスク
  - プロジェクト内では工数の問題で k8s upgrade を 2〜4個まとめて upgrade することが多く、一気に切り替えることによる機能的、心理的リスクが大きい問題があった
  - 実際、1.24 -> 1.28 でトラブルが起きて、EKS upgrade 影響なのかどうか切り分けに時間を要する問題が発生した (高負荷時に EKS コントロールプレーン遅延が起きる問題)
- システムの計画メンテナンスが必須
  - 24時間稼働することを期待されるサービスだが、EKS upgrade の頻度でメンテナンスが必要だった
- 大きなトイル
  - 工数が大きい割に EOL に追われながら作業するため、タスクのクリティカルパスになりがちでタスク圧迫の原因になりがちだった

#### 問題解決方法
アーキテクチャ間のカナリアリリースすることで、メンテナンス不要で、オンライン切り替えを可能にする仕組みを実現した

```
          ┌─── SQS(1.28用) ---> EKS(1.28)
UI(ECS) ──┤
          └─── SQS(1.31用) ---> EKS(1.31)
```

#### 具体的な実装内容
- EKS カナリアの流量制御を管理画面から実行できるようにした
- SQS タグフィルタ
  - 元々 SQS の queue URL は UIと EKS に環境変数で設定していた。
  - EKS カナリアを実現すると、UI + EKS の環境変数が 2倍になり、設定箇所が200個以上になる見込みだった。
  - そのため SQS queue URL を自動解決できるようにした。Terraform で新 version の SQS を作成した際に EKS version タグを付与し、管理画面やアプリケーションはタグを元にジョブの種類を自動判定することで SQS の環境変数を全て不要にした。
- UI: EKSカナリアの設定を参照して対象のSQSにエンキューする処理
- EKS: SQS 参照方法をタグフィルタ版に差し替え
- CI/CD: matrixによる複数 version デプロイ
  - 1_28 と 1_31 のように2つの文字列を羅列するだけで CI/CD をスケールできるようにした
  - k8s のマニフェストも全てをコピーするのではなく、ごく僅かな一部以外は新旧マニフェストを用意せず共通のマニフェストでシンプルな運用管理を目指した
  - 集計のような CronJob は EKS カナリアを有効にしたら自動的に片系のみで動くようにした
- 例外的な CronJob
  - 一部の cronjob は 2 version 共存必須だったため、共存の仕組みを実装した
  - 例えば JobHealthDetector という機能
    - 1時間以内に作られたジョブの中で、実行中かつ 5分以上更新がない一覧を抽出し、pod 一覧と比較して、pod が存在しなければ 自動的にエラー status にする機能
    - EKSクラスタが 2つ共存した場合、片方のクラスタがもう片方のクラスタで実行中の pod 情報を取れないため、ロジックが破綻してしまう
    - 片方のクラスタで抽出した候補を Redis に保存しておき別クラスタで同じ候補を検出すればメンテ対象とした。処理は setex で排他。
- これら全て1人で実装。
- 期間は 2024年9月〜2025年1月。週3 稼働なので実質 3ヶ月

#### 成果
品質向上および運用効率化を実現。

- upgrade リスクを大きく減らせた
  - 流入割合を少しずつにすることで upgrade 影響を少しずつ確認できるようになった。
  - 旧 version を落としてから、新 version を速やかに起動する、といった人間の手順依存もなくせた
- 計画メンテナンスを 1つ不要にできた。
- トイルを減らせた
  - メンテナンス中に移行後の動作確認を行う必要があったが、カナリアの仕組みで多くを不要にできた。
  - 結果、1バージョンずつの upgrade のハードルが下がった

### 2. k8s Job のメモリ確保量を 1000 GB 以上削減
#### 課題
TROCCO のワークフロー機能には多くの問題があった
- 無駄なリソース占有が多い問題
- 長い開発の歴史の中で、処理の冪等性が失われてしまっていた
- 特定条件下におけるニッチなバグ

#### 問題解決方法
- 具体的な内容は以下の記事で解説している
- https://zenn.dev/primenumber/articles/20241221-trocco-workflow-deployment

#### 成果
- アプリケーションロジックや DB 構造を見直し、冪等性を達成した
- アーキテクチャ移行により、1000 GB以上のメモリ確保量を削減した
- 起動速度が 3分ほど高速化した
- 特定条件下におけるニッチなバグを解消した
  - 手動キャンセルが特定条件下で親ワークフローから子ワークフローへ伝達しない問題があった
  - 実装時に本番環境でたまたま再現してくれたため、粘り強く追って特定および修正した
- 新旧アーキテクチャを共存しながら運用する仕組みも合わせて実現し、安全なリリースを行った

